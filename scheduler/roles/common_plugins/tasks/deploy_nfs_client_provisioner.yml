#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Download NFS Client Provisioner tarball
  ansible.builtin.get_url:
    url: "{{ nfs_subdir_external_provisioner_repo }}"
    dest: "{{ nfs_subdir_external_provisioner_dest_repo }}"
    mode: "{{ file_mode }}"

- name: Deploy NFS Client Provisioner using Helm
  community.kubernetes.helm:
    name: "nfs-omnia"
    chart_ref: "{{ nfs_subdir_external_provisioner_dest_repo }}"
    release_namespace: "default"
    values:
      nfs:
        server: "{{ hostvars['127.0.0.1']['k8s_nfs_server_ip'] }}"
        path: "{{ hostvars['127.0.0.1']['k8s_server_share_path'] }}"
  when: "'nfs-subdir-external-provisioner' not in k8s_pods.stdout"

- name: Set NFS Client Provisioner as default StorageClass
  kubernetes.core.k8s:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: nfs-client
    merge_type: strategic-merge
    definition:
      metadata:
        annotations:
          storageclass.kubernetes.io/is-default-class: "true"

- name: Include pod status
  ansible.builtin.include_tasks: pod_status.yml
  vars:
    track_module_name: "nfs-subdir-external-provisioner"
