#!/bin/bash
################################################################################################################
#  omnia_allow_firewall_ports:
#      Allow ports and services in the firewall on SNs and MNs
#
#################################################################################################################

log_file="/var/log/xcat/xcat.log"

# Logging function
log() {
    local level="$1"
    shift
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $*" >> "$log_file"
}

# All ports (xCAT + PCS)
firewall_ports=(
  "3001/tcp" "3001/udp" "3002/tcp" "3002/udp"
  "7/udp" "22/tcp" "22/udp" "873/tcp" "873/udp"
  "67/udp" "68/tcp" "69/tcp" "69/udp"
  "80/tcp" "80/udp" "111/udp"
  "514/tcp" "514/udp" "782/tcp"
  "2049/tcp" "2049/udp" "4011/tcp"
  "623/tcp" "623/udp" "161/tcp" "161/udp"
  "162/tcp" "162/udp" "2240/tcp"
  "5432/tcp" "5432/udp"
  "5404-5405/udp" "3121/tcp" "2224/tcp" "2222/tcp"
)

# All services (PCS + NFS)
firewall_services=(
  "http" "https" "nfs" "rpc-bind"
)

log "INFO" "Starting firewall configuration..."

# Ensure firewalld is installed
if ! rpm -q firewalld &>/dev/null; then
  log "INFO" "Installing firewalld..."
  dnf install -y firewalld && log "SUCCESS" "firewalld installed." || log "ERROR" "Failed to install firewalld."
fi

# Enable and start firewalld
log "INFO" "Enabling and starting firewalld..."
systemctl enable --now firewalld && log "SUCCESS" "firewalld enabled and started." || log "ERROR" "Failed to enable/start firewalld."

# Add ports
log "INFO" "Adding required ports to firewalld..."
for port in "${firewall_ports[@]}"; do
  if firewall-cmd --permanent --add-port="$port"; then
    log "SUCCESS" "Allowed port: $port"
  else
    log "ERROR" "Failed to allow port: $port"
  fi
done

# Add services
log "INFO" "Adding required services to firewalld..."
for service in "${firewall_services[@]}"; do
  if firewall-cmd --permanent --add-service="$service"; then
    log "SUCCESS" "Allowed service: $service"
  else
    log "ERROR" "Failed to allow service: $service"
  fi
done

# Reload firewall
if firewall-cmd --reload; then
  log "SUCCESS" "firewalld reloaded successfully."
else
  log "ERROR" "Failed to reload firewalld."
fi

log "INFO" "âœ… Firewall configuration completed."
